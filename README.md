# Дипломная работа по схеме Host in Docker, в проекте зайдествованы:

- Terraform
- Google cloud
- Docker Compose
- GitHub Actions

# Перед развёртыванием приложения предварительно было сделано:

- В Google Cloud зарезервирован статический ip под создаваемую вм, для того что бы не приходилось переделывать внешние DNS записи на новый внешний ip после каждого деплоя.
- В Google Cloud создан пользователь Terraform, от которого запускается Terraform pipline через GitHab Actions.
- Созданы внешние DNS записи для подключения к ресурсам по доменному имени
    - dos21grafana.duckdns.org
    - dos21keycloak.duckdns.org
    - dos21prometeus.duckdns.org
- Сгенерированы сертификаты для внешних доменов.
- Сгенерирована пара ключей, для подключения к создаваемой терраформом виртуальной машине.
- В githab добавлены secrets:
    - Внешний IP виртуальной машины для подключения к vm
    - Username для подключения к vm
    - Закрытый ключ для подключения к vm
    - JSON Web Token для подключения Terraform к Google Cloud

# Общее описание структуры приложения

- Структура состоит из 5 контейнеров, которые разворачиваются на одной виртуальной машине в Google Cloud путём запуска Docker-compose внутри VM:
    - Keycloak, основой контейнер с приложением отвечающим за SSO;
    - Postgres, база данных для keycloak;
    - Prometeus, собирает метрики keycloak;
    - Grafana, визуализация метрик Prometeus (Авторизация в графане происходит через Keycloak, как единую точку входа);
    - Nginx, выступает в роли reverse-proxy, обеспечивает https подключение к контейнерам.

# Как деплоится приложение

- После пуша в main ветку запускается первый workflow, terraform, который создаёт виртуальную машину в Google Cloud.
- После завершения создания ВМ, запускается второй workflow, vm_preparation, который устанавливает на виртуальную машину docker и git.
- После завершения подготовки вм, запускается последний workflow, который поднимает контейнеры на виртуальной машине. 

